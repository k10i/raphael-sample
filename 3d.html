<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>3D</title>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="js/raphael-min.js"></script>
    <script>
    $(function() {
      var items;
      var stage = {width: 500, height: 500};
      var screenX = stage.width / 2;
      var screenY = stage.height / 2;

      var radius = 30;
      var Z_MAX = 1000;
      var vp = {x: screenX, y: screenY}; //消失点(vanishing point)

      var camera = {x: 0, y: 0, z: -500}; //カメラ

      var paper = Raphael(document.getElementById('svgStage'), stage.width, stage.height);

      function stageInit() {
        paper.rect(0, 0, stage.width, stage.height).attr({
          'stroke': 'black'
        });
        paper.text(10, stage.height - 35, 
                   "camera.x: " + camera.x +
                   "\ncamera.y: " + camera.y +
                   "\ncamera.z: " + camera.z
                   ).attr({'font-size': '16px', 'text-anchor': 'start'})
      }

      function itemsInit() {
        items = [];
      }

      stageInit();
      itemsInit();
      function drawCircle(aX, aY, aZ) {

        if (camera.z > aZ) {
          return;
        }

        var scale = (aZ - camera.z) / Z_MAX;
        if (scale > 1.0) scale = 1.0;

        var _x = aX + screenX;
        var _y = aY + screenY;

        _x = _x + (vp.x - _x) * scale - camera.x * scale;
        _y = _y + (vp.y - _y) * scale - camera.y * scale;
        
        var _radius = radius * (1 - scale);

        console.log([_x, _y, aZ, scale, _radius]);

        items.push({
          x: _x,
          y: _y,
          z: aZ,
          radius: _radius
        });
/*
        var circle = paper.circle(_x, _y, _radius).attr({
          'fill':'blue', 
          'stroke':'white'
        });
*/
      }

      function render() {
        console.log([camera.x, camera.y, camera.z]);
        paper.clear();
        stageInit();
        itemsInit();
        
        drawCircle(0, 0, 0);
/*
        drawCircle(100, 0, 500);
        drawCircle(100, 0, 400);
        drawCircle(100, 0, 300);
        drawCircle(100, 0, 200);
        drawCircle(100, 0, 100);
*/
        items = items.sort(function(a, b){ return b.z - a.z }); // zの降順でソート

        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          paper.circle(item.x, item.y, item.radius).attr({
            'fill':'blue', 
            'stroke':'white'
          });
        }
      }
      render();
//      setInterval(render, 100);

      $("#zoomOut").click(function() {
        camera.z += 100;
        render();
      });

      $("#zoomIn").click(function() {
        camera.z -= 100;
        render();
      });

      $("#moveLeft").click(function() {
        camera.x -= 10;
        render();
      });

      $("#moveRight").click(function() {
        camera.x += 10;
        render();
      });

      $("#moveTop").click(function() {
        camera.y += 10;
        render();
      });

      $("#moveBottom").click(function() {
        camera.y -= 10;
        render();
      });
    });


    </script>
  </head>
  <body>
    <div id="svgStage"></div>
    <div>
      カメラの位置<br />
      <input id="zoomOut" type="button" value="Z+">
      <input id="zoomIn" type="button" value="Z-"><br />
      <input id="moveRight" type="button" value="X+">
      <input id="moveLeft" type="button" value="X-"><br />
      <input id="moveTop" type="button" value="Y+">
      <input id="moveBottom" type="button" value="Y-"><br />
    </div>
  </body>
</html>
